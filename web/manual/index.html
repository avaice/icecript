<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <title>icecript spa page</title>
  </head>
  <body>
    <main></main>

    <footer>
      <p>(C) 2023 avaice</p>
    </footer>

    <script type="text/icecript" src="pages/index.ic"></script>
    <script type="text/icecript" src="pages/notFoundPage.ic"></script>
    <script type="text/icecript" src="pages/main.ic"></script>
    <script src="bundle.js"></script>
    <script>
      let iceScriptCode
      let entryPoint
      const render = () => {
        const urlParams = new URLSearchParams(window.location.search)
        const id = urlParams.get('id')
        const href = location.href
        if (href.includes(entryPoint) && id) {
          console.log('render')
          icecript(iceScriptCode, id)
        } else if (location.href === entryPoint) {
          icecript(iceScriptCode)
        }
      }

      document.addEventListener('DOMContentLoaded', async () => {
        entryPoint = location.href
        const scriptArray = []
        const iceScriptElement = document.querySelectorAll('script[type="text/icecript"]')

        for (let i = 0; i < iceScriptElement.length; i++) {
          const src = await fetch(iceScriptElement[i].src).then((v) => v.text())
          scriptArray.push(src)
        }

        iceScriptCode = scriptArray.join('\n')
        render()
      })
      window.addEventListener('popstate', render)
    </script>
  </body>
</html>
